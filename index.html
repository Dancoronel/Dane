<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Gastos</title>

<style>
:root{
 --bg:#f4f6f9;
 --card:#ffffff;
 --primary:#2563eb;
 --primary-soft:#e8f0ff;
 --dark:#0f172a;
 --muted:#6b7280;
 --border:#e5e7eb;
 --danger:#dc2626;
}

*{box-sizing:border-box;}

body{
 margin:0;
 font-family:system-ui,-apple-system,BlinkMacSystemFont;
 background:var(--bg);
 color:var(--dark);
 line-height:1.45;
}

/* HEADER */

header{
 background:var(--dark);
 color:white;
 padding:18px 20px;
}

header h1{
 margin:0;
 font-size:20px;
 font-weight:600;
}

/* SCREENS */

.screen{
 display:none;
 padding:18px 20px;
 padding-bottom:110px;
}

.active{display:block;}

/* CARD */

.card{
 background:var(--card);
 border-radius:14px;
 padding:18px 16px;
 margin-bottom:18px;
 box-shadow:0 4px 14px rgba(0,0,0,.06);
}

.small{
 font-size:13px;
 color:var(--muted);
}

/* TOTAL HOME */

.total-principal{
 text-align:center;
 cursor:pointer;
}

#totalMes{
 font-size:34px;
 font-weight:700;
 margin:6px 0 4px;
}

/* MINI-MESES */

.row-3{
 display:flex;
 gap:10px;
 margin-bottom:18px;
}

.mini-card{
 flex:1;
 background:var(--card);
 border-radius:12px;
 padding:12px;
 text-align:center;
 box-shadow:0 2px 8px rgba(0,0,0,.05);
 cursor:pointer;
 transition:.15s ease;
}

.mini-card:hover{
 background:var(--primary-soft);
}

.mini-card .mes{font-size:13px;color:var(--muted);}
.mini-card .monto{font-size:16px;font-weight:600;margin-top:6px;}

/* GASTOS LISTA */

#gastosLista .gasto-item{
 padding:10px 0;
 border-bottom:1px solid var(--border);
 font-size:14px;
}

.gasto-top{
 display:flex;
 justify-content:space-between;
 align-items:center;
}

.gasto-desc{
 font-size:16px;
 font-weight:600;
}

.gasto-cuota{
 font-size:16px;
 font-weight:600;
 color:var(--dark);
}

.gasto-meta{
 font-size:12px;
 color:var(--muted);
 margin-top:3px;
}

.gasto-actions button{
 font-size:12px;
 margin-right:8px;
 padding:6px 10px;
 border-radius:8px;
 border:none;
 cursor:pointer;
}

.gasto-actions .edit-btn{background:#2563eb;color:white;}
.gasto-actions .delete-btn{background:var(--danger);color:white;}

/* FORM */

input,select{
 width:100%;
 padding:14px;
 margin:8px 0;
 border-radius:14px;
 border:1px solid var(--border);
 font-size:14px;
}

input:focus,select:focus{
 outline:none;
 border-color:var(--primary);
}

button.primary{
 background:var(--primary);
 color:white;
 border:none;
 padding:14px;
 border-radius:14px;
 cursor:pointer;
 font-size:14px;
}

button.danger{
 background:var(--danger);
 color:white;
 border:none;
 padding:14px;
 border-radius:14px;
 cursor:pointer;
 font-size:14px;
}

/* FAB */

.fab{
 position:fixed;
 bottom:80px;
 right:20px;
 width:58px;
 height:58px;
 border-radius:50%;
 background:var(--primary);
 color:white;
 font-size:28px;
 border:none;
 box-shadow:0 8px 20px rgba(0,0,0,.25);
}

/* NAV */

.bottom-nav{
 position:fixed;
 bottom:0;
 left:0;
 right:0;
 display:flex;
 justify-content:space-around;
 background:var(--dark);
 padding:12px 0;
}

.bottom-nav button{
 background:none;
 border:none;
 color:white;
 font-size:13px;
}
</style>
</head>
<body>

<header>
<h1>Gestor de Gastos</h1>
</header>

<!-- HOME -->

<div id="home" class="screen active">

<div class="card total-principal" onclick="verMes(mesActualKey)">
 <div class="small">Mes actual</div>
 <div id="totalMes">$0.00</div>
 <div id="nombreMesActual" class="small"></div>
</div>

<div id="tresMeses"></div>

<div class="card">
 <div class="small" style="margin-bottom:10px">Próximos 9 meses</div>
 <div id="nueveMeses"></div>
</div>

</div>

<!-- GASTOS -->

<div id="gastos" class="screen">
<h2>Gastos</h2>
<div id="gastosLista"></div>
</div>

<!-- DETALLE GASTO -->

<div id="detail" class="screen"></div>

<!-- NUEVO GASTO -->

<div id="new" class="screen">
<h2 id="formTitle">Nuevo gasto</h2>
<input id="descripcion" placeholder="Descripción">
<input id="valorCuota" type="number" step="0.01" placeholder="Valor cuota">
<input id="cuotas" type="number" placeholder="Cantidad de cuotas">
<input id="cuotasPagadas" type="number" placeholder="Cuotas ya pagadas">
<label class="small">Fecha de compra</label>
<input id="fechaCompra" type="date">
<select id="metodoPago"></select>
<button class="primary" onclick="guardarGasto()">Guardar</button>
</div>

<!-- SETTING -->

<div id="settings" class="screen">
<h2>Ajustes</h2>
<input id="ingreso" type="number" step="0.01" placeholder="Ingreso mensual">
<h3>Métodos de pago</h3>
<input id="nuevoMetodo" placeholder="Nuevo método">
<button class="primary" onclick="agregarMetodo()">Agregar método</button>
<div id="metodos"></div>
<button class="primary" onclick="guardarAjustes()">Guardar ajustes</button>
</div>

<button class="fab" onclick="mostrar('new')">+</button>

<div class="bottom-nav">
<button onclick="mostrar('home')">Home</button>
<button onclick="mostrar('gastos')">Gastos</button>
<button onclick="mostrar('settings')">Ajustes</button>
</div>

<script>
let db = JSON.parse(localStorage.getItem('db')) || {
 ingreso:0,
 metodos:['Efectivo'],
 gastos:[]
};

let mapaMesesGlobal = {};
let mesActualKey = '';
let editingId = null;

// Guardar db
function saveDB(){localStorage.setItem('db',JSON.stringify(db));}

// Navegar
function mostrar(id){
 document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 if(id==='home') calcular();
 if(id==='gastos') renderGastos();
 if(id==='settings') renderSettings();
 if(id==='new') cargarMetodos();
}

// Nombre de mes
function nombreMes(date){
 return date.toLocaleDateString('es-AR',{month:'long',year:'numeric'});
}

// Cargar métodos en select
function cargarMetodos(){
 metodoPago.innerHTML='';
 db.metodos.forEach(m=> metodoPago.innerHTML+=`<option>${m}</option>`);
}

// Calcular home
function calcular(){
 let hoy=new Date();
 mesActualKey=hoy.getFullYear()+'-'+String(hoy.getMonth()+1).padStart(2,'0');
 mapaMesesGlobal={};

 db.gastos.forEach(g=>{
  let inicio=new Date(g.fechaCompra);
  let cuota=Math.round((g.valorCuota)*100)/100;
  for(let i=0;i<g.cuotas;i++){
   let d=new Date(inicio);
   d.setMonth(d.getMonth()+i);
   let key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
   if(!mapaMesesGlobal[key]) mapaMesesGlobal[key]=[];
   mapaMesesGlobal[key].push({desc:g.descripcion,monto:cuota});
  }
 });

 let totalActual=(mapaMesesGlobal[mesActualKey]||[])
  .reduce((a,b)=>a+b.monto,0);
 totalMes.textContent='$'+totalActual.toFixed(2);
 nombreMesActual.textContent=nombreMes(hoy);

 let meses=[];
 for(let i=1;i<=12;i++){
  let d=new Date(hoy);
  d.setMonth(d.getMonth()+i);
  let key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
  meses.push({date:d,key});
 }

 tresMeses.innerHTML=
 `<div class="row-3">`+
 meses.slice(0,3).map(m=>{
  let total=(mapaMesesGlobal[m.key]||[])
   .reduce((a,b)=>a+b.monto,0);
  return `<div class="mini-card" onclick="verMes('${m.key}')">
   <div class="mes">${nombreMes(m.date)}</div>
   <div class="monto">$${total.toFixed(2)}</div>
  </div>`;
 }).join('')
 +`</div>`;

 nueveMeses.innerHTML=
 meses.slice(3).map(m=>{
  let total=(mapaMesesGlobal[m.key]||[])
   .reduce((a,b)=>a+b.monto,0);
  return `<div>${nombreMes(m.date)} — $${total.toFixed(2)}</div>`;
 }).join('');
}

// Render Gastos lista compacta
function renderGastos(){
 const lista=document.getElementById("gastosLista");
 lista.innerHTML='';

 db.gastos.forEach(g=>{
  const cuotasPagadas = g.cuotasPagadas || 0;
  const fechaUlt = calcularFechaUltimaCuota(g);
  const div=document.createElement("div");
  div.className="gasto-item";
  div.innerHTML=`
   <div class="gasto-top">
     <div class="gasto-desc">${g.descripcion}</div>
     <div class="gasto-cuota">$${g.valorCuota.toFixed(2)}</div>
   </div>
   <div class="gasto-meta">
     ${cuotasPagadas} de ${g.cuotas} · ${fechaUlt}
   </div>
   <div class="gasto-actions">
     <button class="edit-btn" onclick="editarGasto('${g.id}')">Editar</button>
     <button class="delete-btn" onclick="eliminarGasto('${g.id}')">Eliminar</button>
   </div>
  `;
  lista.appendChild(div);
 });
}

// Calcular fecha última cuota
function calcularFechaUltimaCuota(g){
 let inicio=new Date(g.fechaCompra);
 let fin=new Date(inicio);
 fin.setMonth(fin.getMonth()+g.cuotas-1);
 return nombreMes(fin);
}

// Eliminar gasto
function eliminarGasto(id){
 db.gastos=db.gastos.filter(x=> x.id!==id);
 saveDB();
 renderGastos();
}

// Editar gasto
function editarGasto(id){
 const gasto=db.gastos.find(x=>x.id===id);
 if(!gasto) return;
 editingId=id;
 mostrar("new");
 formTitle.textContent="Editar gasto";
 document.getElementById("descripcion").value=gasto.descripcion;
 document.getElementById("valorCuota").value=gasto.valorCuota;
 document.getElementById("cuotas").value=gasto.cuotas;
 document.getElementById("cuotasPagadas").value=gasto.cuotasPagadas||0;
 document.getElementById("fechaCompra").value=gasto.fechaCompra;
 document.getElementById("metodoPago").value=gasto.metodoPago;
}

// Guardar gasto (nuevo o editar)
function guardarGasto(){
 const desc=document.getElementById("descripcion").value;
 const val=parseFloat(document.getElementById("valorCuota").value);
 const cuot=parseInt(document.getElementById("cuotas").value);
 const cp=parseInt(document.getElementById("cuotasPagadas").value)||0;
 const fc=document.getElementById("fechaCompra").value;
 const mp=document.getElementById("metodoPago").value;

 if(editingId){
  const idx=db.gastos.findIndex(x=>x.id===editingId);
  db.gastos[idx]={id:editingId,descripcion:desc,valorCuota:val,cuotas:cuot,cuotasPagadas:cp,fechaCompra:fc,metodoPago:mp};
  editingId=null;
 } else {
  db.gastos.push({id:Date.now().toString(),descripcion:desc,valorCuota:val,cuotas:cuot,cuotasPagadas:cp,fechaCompra:fc,metodoPago:mp});
 }
 saveDB();
 mostrar("gastos");
}

// Ver detalle individual
function verDetalle(id){
 const g=db.gastos.find(x=>x.id===id);
 let fin=new Date(g.fechaCompra);
 fin.setMonth(fin.getMonth()+g.cuotas-1);

 detail.innerHTML=`
 <div class="card">
  <h2>${g.descripcion}</h2>
  <p>Total cuota: $${g.valorCuota.toFixed(2)}</p>
  <p>Cuotas: ${g.cuotas}</p>
  <p>Cuotas pagadas: ${g.cuotasPagadas||0}</p>
  <p>Fecha compra: ${g.fechaCompra}</p>
  <p>Método: ${g.metodoPago}</p>
  <p>Fin de cuotas: ${fin.toISOString().slice(0,10)}</p>
  <button class="danger" onclick="eliminarGasto('${id}')">Eliminar</button>
  <button onclick="mostrar('gastos')">Volver</button>
 </div>`;
 mostrar("detail");
}

// Render settings
function renderSettings(){
 ingreso.value=db.ingreso;
 metodos.innerHTML=db.metodos.map(m=>'<div>'+m+'</div>').join('');
}

// Guardar ajustes
function guardarAjustes(){
 db.ingreso=+ingreso.value;
 saveDB();
 mostrar("home");
}

// Init
calcular();
</script>

</body>
</html>
